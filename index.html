<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDM Archive v13.11</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --sunday-color: #ef4444;
            --saturday-color: #3b82f6;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #111827;
                --text-color: #f9fafb;
                --card-bg: #1f2937;
                --border-color: #374151;
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-color); padding: 20px; transition: background-color 0.3s, color 0.3s; }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 1.5rem; font-weight: bold; }
        .nav-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-color); padding: 5px 10px; }

        /* íƒ­ ë©”ë‰´ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: var(--card-bg); padding: 5px; border-radius: 10px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 8px; font-weight: 600; transition: 0.2s; }
        .tab.active { background-color: var(--primary-color); color: white; }

        /* ë‹¬ë ¥ ê·¸ë¦¬ë“œ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: var(--border-color); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
        .calendar-header { background-color: var(--card-bg); padding: 10px; text-align: center; font-weight: bold; font-size: 0.9rem; }
        .calendar-cell { background-color: var(--card-bg); min-height: 100px; padding: 5px; cursor: pointer; position: relative; display: flex; flex-direction: column; gap: 2px; }
        
        .date-num { font-size: 0.9rem; margin-bottom: 4px; font-weight: bold; }
        .schedule-dot { width: 6px; height: 6px; background-color: var(--primary-color); border-radius: 50%; margin: 0 auto; }
        
        /* PC ë²„ì „: ë‹¬ë ¥ ë‚´ í…ìŠ¤íŠ¸ í‘œì‹œ */
        .schedule-text-preview { 
            font-size: 0.75rem; 
            color: white; 
            background-color: var(--primary-color); 
            padding: 2px 4px; 
            border-radius: 4px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            margin-top: 2px;
            display: none; /* ëª¨ë°”ì¼ ê¸°ë³¸ ìˆ¨ê¹€ */
        }
        @media (min-width: 768px) {
            .schedule-text-preview { display: block; } 
            .schedule-dot { display: none; }
        }

        .sunday { color: var(--sunday-color); }
        .saturday { color: var(--saturday-color); }
        .today { background-color: rgba(59, 130, 246, 0.1); }

        /* ë¦¬ìŠ¤íŠ¸ ë·° */
        .list-view { display: none; flex-direction: column; gap: 10px; }
        .list-item { background: var(--card-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color); }
        .list-date { font-size: 0.9rem; color: #888; margin-bottom: 5px; }
        .list-content { font-size: 1rem; font-weight: 500; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 500px; border-radius: 15px; padding: 20px; max-height: 90vh; overflow-y: auto; position: relative; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 1.2rem; font-weight: bold; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color); }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .input-field { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); font-size: 1rem; }
        textarea.input-field { min-height: 100px; resize: vertical; }

        /* ë§í¬ ì…ë ¥ í–‰ ìŠ¤íƒ€ì¼ (ê°œì„ ë¨) */
        .link-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .link-name-input { flex: 1; min-width: 30%; } /* ì œëª© ì…ë ¥ì¹¸ */
        .link-url-input { flex: 2; } /* ì£¼ì†Œ ì…ë ¥ì¹¸ */
        .link-remove-btn { background: #ef4444; color: white; border: none; width: 30px; height: 38px; border-radius: 5px; cursor: pointer; }

        .add-link-btn { width: 100%; padding: 8px; background: #6b7280; color: white; border: none; border-radius: 8px; margin-bottom: 15px; cursor: pointer; }

        /* íŒŒì¼ ì²¨ë¶€ ë¯¸ë¦¬ë³´ê¸° */
        .file-preview-area { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .file-tag { background: #eee; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; color: #333; }
        .file-tag button { background: none; border: none; color: red; font-weight: bold; cursor: pointer; }
        .img-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        /* ë·° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .view-content { white-space: pre-wrap; line-height: 1.6; margin: 15px 0; max-height: 300px; overflow-y: auto; }
        .view-links { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        .link-btn { 
            display: flex; align-items: center; gap: 8px;
            padding: 10px; background: #eff6ff; color: #1e40af; 
            text-decoration: none; border-radius: 8px; font-size: 0.9rem; font-weight: 500;
            border: 1px solid #dbeafe; transition: 0.2s;
        }
        .link-btn:hover { background: #dbeafe; }
        .link-btn i { font-size: 1.1em; }
        
        /* ë·° ëª¨ë‹¬ ì´ë¯¸ì§€ í‘œì‹œ */
        .view-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .view-img-item { width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px; border: 1px solid var(--border-color); }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 900; }

        .data-manage-box { background: var(--card-bg); padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid var(--border-color); }
        .data-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; text-align: left; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <button class="nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="title" id="currentMonth"></div>
        <button class="nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('calendar')">ë‹¬ë ¥</div>
        <div class="tab" onclick="switchTab('list')">ëª©ë¡</div>
        <div class="tab" onclick="switchTab('data')">ë°ì´í„°</div>
    </div>

    <div id="calendarView" class="calendar-grid">
        </div>

    <div id="listView" class="list-view">
        </div>

    <div id="dataView" class="list-view" style="display: none;">
        <div class="data-manage-box">
            <h3>ë°ì´í„° ê´€ë¦¬</h3>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">
                ì„œë²„ ì—†ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.<br>
                ê¸°ê¸°ë¥¼ ì˜®ê¸¸ ë•ŒëŠ” ë°±ì—… íŒŒì¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.
            </p>
            <button class="data-btn" onclick="backupData()">
                <i class="fas fa-download"></i> ì „ì²´ ë°ì´í„° ë°±ì—… (íŒŒì¼ ì €ì¥)
            </button>
            <button class="data-btn" onclick="document.getElementById('restoreFile').click()">
                <i class="fas fa-upload"></i> ë°±ì—… íŒŒì¼ë¡œ ë³µì›
            </button>
            <input type="file" id="restoreFile" style="display: none;" onchange="restoreData(this)" accept=".json">
            <button class="data-btn" onclick="clearAllData()" style="color: #ef4444;">
                <i class="fas fa-trash"></i> ì „ì²´ ë°ì´í„° ì‚­ì œ (ì´ˆê¸°í™”)
            </button>
        </div>
    </div>

    <div id="writeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">ì¼ì • ê¸°ë¡</span>
                <button class="close-btn" onclick="closeModal('writeModal')">&times;</button>
            </div>
            <div class="input-group">
                <label>ë‚ ì§œ</label>
                <input type="date" id="scheduleDate" class="input-field">
            </div>
            <div class="input-group">
                <label>ì œëª©</label>
                <input type="text" id="scheduleTitle" class="input-field" placeholder="ì¼ì • ì œëª©">
            </div>
            <div class="input-group">
                <label>ë‚´ìš©</label>
                <textarea id="scheduleContent" class="input-field" placeholder="ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            
            <div class="input-group">
                <label>ê´€ë ¨ ë§í¬ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë“±)</label>
                <div id="linkContainer">
                    </div>
                <button type="button" class="add-link-btn" onclick="addLinkField()">+ ë§í¬ ì¶”ê°€</button>
            </div>

            <div class="input-group">
                <label>íŒŒì¼ ì²¨ë¶€ (ì´ë¯¸ì§€ ìë™ ì••ì¶•)</label>
                <input type="file" id="fileInput" class="input-field" multiple accept="image/*,.pdf,.xlsx,.hwp" onchange="handleFileSelect(this)">
                <div id="filePreviewArea" class="file-preview-area"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-danger" id="deleteBtn" style="display: none;" onclick="deleteSchedule()">ì‚­ì œ</button>
                <button class="btn btn-primary" onclick="saveSchedule()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="viewDate"></span>
                <button class="close-btn" onclick="closeModal('viewModal')">&times;</button>
            </div>
            <h3 id="viewTitle" style="margin-bottom: 10px;"></h3>
            <div id="viewContent" class="view-content"></div>
            
            <div id="viewLinks" class="view-links"></div>
            
            <div id="viewImages" class="view-images"></div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="editCurrentSchedule()">ìˆ˜ì •</button>
                <button class="btn" onclick="closeModal('viewModal')" style="background: #9ca3af; color: white;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div class="fab" onclick="openWriteModal()">+</div>

    <script>
        let currentDate = new Date();
        let schedules = JSON.parse(localStorage.getItem('jdm_schedules')) || {};
        let currentEditId = null;
        let attachedFiles = []; // íŒŒì¼ ì„ì‹œ ì €ì¥ìš©

        // ì´ˆê¸° ì‹¤í–‰
        renderCalendar();
        
        // --- 1. ë‹¬ë ¥ ë° íƒ­ ê´€ë ¨ í•¨ìˆ˜ ---
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').innerText = `${year}ë…„ ${month + 1}ì›”`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const grid = document.getElementById('calendarView');
            grid.innerHTML = '';
            
            // ìš”ì¼ í—¤ë”
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            days.forEach((d, i) => {
                const div = document.createElement('div');
                div.className = 'calendar-header' + (i === 0 ? ' sunday' : (i === 6 ? ' saturday' : ''));
                div.innerText = d;
                grid.appendChild(div);
            });

            // ë¹ˆ ë‚ ì§œ ì±„ìš°ê¸°
            for (let i = 0; i < firstDay.getDay(); i++) {
                grid.appendChild(document.createElement('div'));
            }

            // ë‚ ì§œ ì±„ìš°ê¸°
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                
                const todayStr = new Date().toISOString().split('T')[0];
                if (dateStr === todayStr) cell.classList.add('today');

                const dayOfWeek = new Date(year, month, i).getDay();
                let dateClass = 'date-num';
                if (dayOfWeek === 0) dateClass += ' sunday';
                if (dayOfWeek === 6) dateClass += ' saturday';

                // ë‚ ì§œ ìˆ«ì
                let html = `<div class="${dateClass}">${i}</div>`;
                
                // ì¼ì • í‘œì‹œ (ì  ë° í…ìŠ¤íŠ¸)
                if (schedules[dateStr]) {
                    // ëª¨ë°”ì¼ìš© ì 
                    html += `<div class="schedule-dot"></div>`;
                    // PCìš© í…ìŠ¤íŠ¸ í”„ë¦¬ë·° (ì²« ë²ˆì§¸ ì¼ì • ì œëª©ë§Œ)
                    html += `<div class="schedule-text-preview">${schedules[dateStr][0].title}</div>`;
                    // ì¼ì •ì´ 2ê°œ ì´ìƒì´ë©´ '+1' í‘œì‹œ ë“±ì€ ìƒëµí•˜ê³  ë‹¨ìˆœí™”
                    if(schedules[dateStr].length > 1) {
                         html += `<div class="schedule-text-preview" style="background:#9ca3af; width: fit-content;">+${schedules[dateStr].length-1}</div>`;
                    }
                }
                
                cell.innerHTML = html;
                cell.onclick = () => showScheduleList(dateStr);
                grid.appendChild(cell);
            }
            
            renderList(); // ëª©ë¡ ë·°ë„ ê°±ì‹ 
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[tabName === 'calendar' ? 0 : (tabName === 'list' ? 1 : 2)].classList.add('active');
            
            document.getElementById('calendarView').style.display = tabName === 'calendar' ? 'grid' : 'none';
            document.getElementById('listView').style.display = tabName === 'list' ? 'flex' : 'none';
            document.getElementById('dataView').style.display = tabName === 'data' ? 'block' : 'none';
            
            document.querySelector('.header').style.display = tabName === 'data' ? 'none' : 'flex';
            document.querySelector('.fab').style.display = tabName === 'data' ? 'none' : 'flex';
        }

        function renderList() {
            const listContainer = document.getElementById('listView');
            listContainer.innerHTML = '';
            
            // ë‚ ì§œìˆœ ì •ë ¬
            const sortedDates = Object.keys(schedules).sort().reverse();
            
            sortedDates.forEach(date => {
                schedules[date].forEach((sch, idx) => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `<div class="list-date">${date}</div><div class="list-content">${sch.title}</div>`;
                    div.onclick = () => openViewModal(date, idx);
                    listContainer.appendChild(div);
                });
            });
        }

        // --- 2. ì¼ì • ë³´ê¸° ë° ëª¨ë‹¬ ê´€ë ¨ ---
        
        function showScheduleList(dateStr) {
            if (!schedules[dateStr]) {
                // ì¼ì •ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ì“°ê¸° ëª¨ë‹¬
                openWriteModal(dateStr);
                return;
            }
            
            // ì¼ì •ì´ 1ê°œë©´ ë°”ë¡œ ìƒì„¸ ë³´ê¸°
            if (schedules[dateStr].length === 1) {
                openViewModal(dateStr, 0);
            } else {
                // 2ê°œ ì´ìƒì´ë©´ ëª©ë¡ íƒ­ìœ¼ë¡œ ì´ë™í•´ì„œ ë³´ì—¬ì¤Œ (ê°„ì†Œí™”)
                switchTab('list');
                // í•´ë‹¹ ë‚ ì§œë¡œ ìŠ¤í¬ë¡¤ ì´ë™ ê¸°ëŠ¥ì€ ìƒëµ
                alert(dateStr + ' ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.');
            }
        }

        function openViewModal(date, index) {
            const sch = schedules[date][index];
            currentEditId = { date, index }; // ìˆ˜ì •/ì‚­ì œë¥¼ ìœ„í•´ ID ì €ì¥
            
            document.getElementById('viewDate').innerText = date;
            document.getElementById('viewTitle').innerText = sch.title;
            document.getElementById('viewContent').innerText = sch.content;
            
            // ë§í¬ í‘œì‹œ (v13.11 ê°œì„ : ì´ë¦„í‘œì‹œ)
            const linksDiv = document.getElementById('viewLinks');
            linksDiv.innerHTML = '';
            if (sch.links) {
                let linkList = [];
                // ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜: ë¬¸ìì—´(êµ¬ë²„ì „)ì´ë©´ ë°°ì—´ë¡œ ë³€í™˜
                if (typeof sch.links === 'string') {
                    // JSON í˜•ì‹ì´ë©´ íŒŒì‹±, ì•„ë‹ˆë©´ ê·¸ëƒ¥ ë¬¸ìì—´ í•˜ë‚˜ë¡œ ì·¨ê¸‰
                    try {
                        if (sch.links.startsWith('[')) {
                            linkList = JSON.parse(sch.links);
                        } else {
                            linkList = [{name: '', url: sch.links}];
                        }
                    } catch(e) {
                        linkList = [{name: '', url: sch.links}];
                    }
                } else if (Array.isArray(sch.links)) {
                    linkList = sch.links;
                }

                linkList.forEach(linkObj => {
                    // ê°ì²´ í˜•íƒœ {name: '...', url: '...'} ë˜ëŠ” ë‹¨ìˆœ ë¬¸ìì—´ ì²˜ë¦¬
                    let url = linkObj.url || linkObj; 
                    let name = linkObj.name || 'ê´€ë ¨ ë§í¬ ë°”ë¡œê°€ê¸°';
                    
                    if (name.trim() === '') name = 'ê´€ë ¨ ë§í¬ ë°”ë¡œê°€ê¸°';

                    if (url) {
                        const a = document.createElement('a');
                        a.href = url.startsWith('http') ? url : 'https://' + url;
                        a.target = '_blank';
                        a.className = 'link-btn';
                        a.innerHTML = `<i class="fas fa-link"></i> ${name}`; // ì•„ì´ì½˜ + ì´ë¦„
                        linksDiv.appendChild(a);
                    }
                });
            }

            // íŒŒì¼(ì´ë¯¸ì§€) í‘œì‹œ
            const imgDiv = document.getElementById('viewImages');
            imgDiv.innerHTML = '';
            if (sch.files && sch.files.length > 0) {
                sch.files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = file.data;
                        img.className = 'view-img-item';
                        imgDiv.appendChild(img);
                    } else {
                        // ì´ë¯¸ì§€ ì™¸ íŒŒì¼ì€ ë‹¤ìš´ë¡œë“œ ë§í¬ì²˜ëŸ¼ í‘œì‹œ
                        const a = document.createElement('a');
                        a.href = file.data; // Base64 ë°ì´í„°
                        a.download = file.name;
                        a.className = 'link-btn';
                        a.innerHTML = `<i class="fas fa-file-download"></i> ${file.name} ë‹¤ìš´ë¡œë“œ`;
                        linksDiv.appendChild(a); // ë§í¬ ì˜ì—­ì— ì¶”ê°€
                    }
                });
            }

            document.getElementById('viewModal').classList.add('active');
        }

        // --- 3. ê¸€ì“°ê¸°/ìˆ˜ì •/ì €ì¥ ë¡œì§ (í•µì‹¬ ë³€ê²½) ---

        function openWriteModal(dateStr = null) {
            document.getElementById('scheduleDate').value = dateStr || new Date().toISOString().split('T')[0];
            document.getElementById('scheduleTitle').value = '';
            document.getElementById('scheduleContent').value = '';
            
            // ë§í¬ ì´ˆê¸°í™”
            document.getElementById('linkContainer').innerHTML = '';
            addLinkField(); // ê¸°ë³¸ 1ê°œ ì¶”ê°€
            
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreviewArea').innerHTML = '';
            document.getElementById('deleteBtn').style.display = 'none';
            attachedFiles = [];
            currentEditId = null;
            
            document.getElementById('writeModal').classList.add('active');
        }

        function editCurrentSchedule() {
            closeModal('viewModal');
            const { date, index } = currentEditId;
            const sch = schedules[date][index];
            
            document.getElementById('scheduleDate').value = date;
            document.getElementById('scheduleTitle').value = sch.title;
            document.getElementById('scheduleContent').value = sch.content;

            // ë§í¬ ë³µì› (v13.11: ì œëª© + URL)
            const container = document.getElementById('linkContainer');
            container.innerHTML = '';
            
            let linkList = [];
            if (sch.links) {
                if (typeof sch.links === 'string' && !sch.links.startsWith('[')) {
                    linkList = [{name: '', url: sch.links}];
                } else {
                    try {
                        linkList = typeof sch.links === 'string' ? JSON.parse(sch.links) : sch.links;
                    } catch(e) { linkList = []; }
                }
            }

            if (linkList.length > 0) {
                linkList.forEach(linkObj => {
                    let url = linkObj.url || linkObj;
                    let name = linkObj.name || '';
                    addLinkField(name, url);
                });
            } else {
                addLinkField();
            }

            // íŒŒì¼ ë³µì›
            attachedFiles = sch.files || [];
            updateFilePreview();

            document.getElementById('deleteBtn').style.display = 'block';
            document.getElementById('writeModal').classList.add('active');
        }

        // v13.11 ì‹ ê·œ í•¨ìˆ˜: ë§í¬ í•„ë“œ ì¶”ê°€ (ì œëª© + URL)
        function addLinkField(nameValue = '', urlValue = '') {
            const container = document.getElementById('linkContainer');
            const div = document.createElement('div');
            div.className = 'link-row';
            div.innerHTML = `
                <input type="text" class="input-field link-name-input" placeholder="ë§í¬ ì œëª©(ì„ íƒ)" value="${nameValue}">
                <input type="text" class="input-field link-url-input" placeholder="https://" value="${urlValue}">
                <button type="button" class="link-remove-btn" onclick="this.parentElement.remove()">-</button>
            `;
            container.appendChild(div);
        }

        function saveSchedule() {
            const date = document.getElementById('scheduleDate').value;
            const title = document.getElementById('scheduleTitle').value;
            const content = document.getElementById('scheduleContent').value;
            
            // ë§í¬ ë°ì´í„° ìˆ˜ì§‘ (JSON ë°°ì—´ë¡œ ì €ì¥)
            const linkRows = document.querySelectorAll('.link-row');
            let links = [];
            linkRows.forEach(row => {
                const name = row.querySelector('.link-name-input').value.trim();
                const url = row.querySelector('.link-url-input').value.trim();
                if (url) {
                    links.push({ name: name, url: url });
                }
            });
            const linksJson = JSON.stringify(links);

            if (!date || !title) {
                alert('ë‚ ì§œì™€ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            if (currentEditId) {
                // ê¸°ì¡´ ì‚­ì œ í›„ ì¬ì¶”ê°€ (ë‚ ì§œ ë³€ê²½ ëŒ€ì‘)
                const { date: oldDate, index } = currentEditId;
                schedules[oldDate].splice(index, 1);
                if (schedules[oldDate].length === 0) delete schedules[oldDate];
            }

            if (!schedules[date]) schedules[date] = [];
            
            schedules[date].push({
                title: title,
                content: content,
                links: linksJson, // v13.11: JSON ë¬¸ìì—´ë¡œ ì €ì¥
                files: attachedFiles
            });

            saveToLocal();
            renderCalendar();
            closeModal('writeModal');
        }

        function deleteSchedule() {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const { date, index } = currentEditId;
            schedules[date].splice(index, 1);
            if (schedules[date].length === 0) delete schedules[date];
            
            saveToLocal();
            renderCalendar();
            closeModal('writeModal');
        }

        // --- 4. íŒŒì¼ ì²˜ë¦¬ ë° ìœ í‹¸ë¦¬í‹° ---

        function handleFileSelect(input) {
            const files = Array.from(input.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ë¡œì§
                    if (file.type.startsWith('image/')) {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // ìµœëŒ€ ê°€ë¡œ 1024pxë¡œ ë¦¬ì‚¬ì´ì§•
                            const maxWidth = 1024;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // JPEG í’ˆì§ˆ 0.7 ì••ì¶•
                            const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                            
                            attachedFiles.push({
                                name: file.name,
                                type: file.type,
                                data: compressedData
                            });
                            updateFilePreview();
                        };
                    } else {
                        // ì¼ë°˜ íŒŒì¼ì€ ê·¸ëŒ€ë¡œ (ìš©ëŸ‰ ì£¼ì˜)
                        attachedFiles.push({
                            name: file.name,
                            type: file.type,
                            data: e.target.result
                        });
                        updateFilePreview();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function updateFilePreview() {
            const area = document.getElementById('filePreviewArea');
            area.innerHTML = '';
            attachedFiles.forEach((file, idx) => {
                const tag = document.createElement('div');
                tag.className = 'file-tag';
                
                let content = '';
                if (file.type.startsWith('image/')) {
                    content = `<img src="${file.data}" class="img-preview">`;
                } else {
                    content = `ğŸ“„ ${file.name}`;
                }
                
                tag.innerHTML = `${content} <button onclick="removeFile(${idx})">X</button>`;
                area.appendChild(tag);
            });
        }

        function removeFile(idx) {
            attachedFiles.splice(idx, 1);
            updateFilePreview();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function saveToLocal() {
            localStorage.setItem('jdm_schedules', JSON.stringify(schedules));
        }

        // ë°ì´í„° ë°±ì—…/ë³µì›
        function backupData() {
            const dataStr = JSON.stringify(schedules);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0,10);
            a.href = url;
            a.download = `JDM_Backup_${date}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ëª¨ë‘ ì§€ìš°ê³  ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        schedules = data;
                        saveToLocal();
                        renderCalendar();
                        alert('ë³µì› ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        switchTab('calendar');
                    }
                } catch (err) {
                    alert('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                localStorage.removeItem('jdm_schedules');
                schedules = {};
                renderCalendar();
                alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
