<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JDM Archive v10.2</title>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #c0392b; --bg-color: #f4f6f7; --nav-height: 65px; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: #333; margin: 0; padding-bottom: var(--nav-height); }
        
        /* í—¤ë” ë””ìì¸ ë³€ê²½ (ì—…ë°ì´íŠ¸ í™•ì¸ìš©: ë°°ê²½ ë‚¨ìƒ‰, ê¸€ì í°ìƒ‰) */
        header { background: var(--primary-color); padding: 15px; border-bottom: 1px solid #1a252f; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; color: white; }
        header h1 { margin: 0; font-size: 1.5rem; flex-grow: 1; text-align: center; margin-left: 40px; color:white; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        
        /* ì•”í˜¸ ì ê¸ˆ */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #loginOverlay input { width: 200px; padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 10px; border: none; margin-top: 20px; letter-spacing: 5px; }
        #loginOverlay button { margin-top: 15px; padding: 10px 30px; background: #c0392b; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }

        /* ê³µí†µ ìŠ¤íƒ€ì¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: white; padding: 10px; border-radius: 12px; }
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; border-radius: 8px; font-size: 0.9rem; cursor: pointer; padding-top: 5px; }
        .cal-day.today { background: #e8f4fd; color: var(--primary-color); font-weight: bold; }
        .dot { width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; margin-top: 4px; }
        
        /* ë©”ëª¨ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .memo-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .list-action-bar { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 8px; }
        .btn-mini { padding: 5px 12px; font-size: 0.85rem; border: none; border-radius: 5px; cursor: pointer; color: white; text-decoration: none; display:inline-block;}
        .btn-edit { background: #f39c12; }
        .btn-del { background: #e74c3c; }
        .btn-link { background: #3498db; }

        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn-save { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        
        /* ê¸°ì¡´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
        #existingImagesArea { display:none; margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:8px; border:1px dashed #ccc; }
        #existingImagesArea img { max-width: 100px; max-height: 100px; margin-right: 5px; border-radius: 5px; border: 1px solid #ddd; }

        /* ê²€ìƒ‰ ë° í•„í„° ì˜ì—­ */
        .search-bar-area { display: flex; gap: 5px; margin-bottom: 15px; }
        .search-bar-area select { width: 35%; margin-bottom: 0; }
        .search-bar-area input { width: 65%; margin-bottom: 0; }

        /* ëª¨ë‹¬ ë° ê¸°íƒ€ */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
        .modal-content { background:white; width:85%; max-width:500px; padding:25px; border-radius:15px; max-height:80vh; overflow-y:auto; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 1.8rem; border: none; background: none; cursor: pointer; color: #999; }
        .view-body img { max-width: 100%; border-radius: 8px; margin: 10px 0; display:block; }
        .view-body { line-height: 1.6; white-space: pre-wrap; font-size: 1rem; color: #333; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 8px; color: #999; font-size: 0.8rem; cursor: pointer; }
        .nav-item.active { color: var(--primary-color); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 3px; }
    </style>
</head>
<body>
<div id="loginOverlay">
    <div style="text-align:center;">
        <h2 style="margin-bottom:10px;">ğŸ”’ JDM Archive</h2>
        <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        <input type="password" id="passInput" maxlength="4" placeholder="****">
        <br>
        <button onclick="checkPass()">ì ‘ ì†</button>
    </div>
</div>

<header>
    <h1>JDM Archive v10.2</h1>
    <button onclick="changePassword()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; padding:5px; color:white;">ğŸ”’</button>
</header>

<div class="container">
    <div id="tab-calendar" class="tab-content active">
        <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:12px; margin-bottom:10px;">
            <button onclick="changeMonth(-1)" style="border:none; background:none; font-size:1.5rem;">â—€</button>
            <h2 id="currentMonth" style="margin:0;"></h2>
            <button onclick="changeMonth(1)" style="border:none; background:none; font-size:1.5rem;">â–¶</button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
        <div id="calendarMemos" style="margin-top:20px; text-align:center; color:#888;"></div>
    </div>

    <div id="tab-list" class="tab-content">
        <div class="search-bar-area">
            <select id="listFilter" onchange="renderMemos()">
                <option value="all">ì „ì²´ë³´ê¸°</option>
                <option value="#ì¼ë°˜">#ì¼ë°˜</option>
                <option value="#ì—…ë¬´">#ì—…ë¬´</option>
                <option value="#ì•„ì´ë””ì–´">#ì•„ì´ë””ì–´</option>
                <option value="#ê±´ê°•">#ê±´ê°•</option>
                <option value="#í˜„ì¥">#í˜„ì¥</option>
                <option value="#AI">#AI</option>
                <option value="#ì‹¬ë¦¬">#ì‹¬ë¦¬</option>
            </select>
            <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´..." onkeyup="renderMemos()">
        </div>
        <div id="memoList"></div>
    </div>

    <div id="tab-write" class="tab-content">
        <div style="background:white; padding:20px; border-radius:12px;">
            <h3 id="writeModeTitle">ğŸ“ ìƒˆ ê¸°ë¡ ì‘ì„±</h3>
            <input type="hidden" id="editModeId">
            
            <input type="text" id="inputTitle" placeholder="ì œëª©">
            <select id="inputTag">
                <option value="#ì¼ë°˜">#ì¼ë°˜</option>
                <option value="#ì—…ë¬´">#ì—…ë¬´</option>
                <option value="#ì•„ì´ë””ì–´">#ì•„ì´ë””ì–´</option>
                <option value="#ê±´ê°•">#ê±´ê°•</option>
                <option value="#í˜„ì¥">#í˜„ì¥</option>
                <option value="#AI">#AI</option>
                <option value="#ì‹¬ë¦¬">#ì‹¬ë¦¬</option>
            </select>
            
            <textarea id="inputContent" style="height:200px" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>

            <div id="existingImagesArea">
                <span style="font-size:0.8rem; color:#666; display:block; margin-bottom:5px;">ğŸ“‚ ê¸°ì¡´ ì²¨ë¶€ ì‚¬ì§„ (ìœ ì§€ë©ë‹ˆë‹¤)</span>
                <div id="existingImagesPreview"></div>
                <input type="hidden" id="hiddenOldImages">
            </div>
            
            <input type="text" id="inputLink" placeholder="ê´€ë ¨ ë§í¬ (URL)">
            
            <label style="display:block; margin-bottom:5px; font-weight:bold;">ğŸ“¸ ì‚¬ì§„ ì¶”ê°€</label>
            <input type="file" id="inputImage" accept="image/*" multiple style="padding:10px; background:#eee; width:100%; margin-bottom:20px;">
            
            <button id="btnSaveAction" class="btn-save" onclick="saveMemo()">ì € ì¥</button>
            <button id="btnCancelEdit" class="btn-save" style="background:#95a5a6; margin-top:10px; display:none;" onclick="cancelEdit()">ì‘ì„± ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="tab-data" class="tab-content">
        <div style="background:white; padding:20px; border-radius:12px; text-align:center;">
            <h3>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
             <div style="background:#fff3cd; padding:15px; border-radius:10px; margin-bottom:15px; border:2px solid #ffc107;">
                <strong style="color:#d35400;">ğŸ“‚ íŒŒì¼ë¡œ ë³µì›</strong>
                <input type="file" id="restoreInput" onchange="restoreData(this)" style="background:white; border:1px solid #ccc; width:100%; margin-top:5px;">
            </div>
            <button onclick="backupData()" class="btn-save" style="background:#27ae60; margin-bottom:10px;">ğŸ“¤ ì „ì²´ ë°±ì—…</button>
            <button onclick="resetApp()" class="btn-save" style="background:#7f8c8d;">âš ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
    </div>
</div>

<div id="viewModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeViewModal()">Ã—</button>
        <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <span id="viewTag" style="color:white; background:var(--accent-color); padding:3px 8px; border-radius:4px; font-size:0.8rem;"></span>
            <span id="viewDate" style="color:#888; font-size:0.9rem; margin-left:10px;"></span>
        </div>
        <h2 id="viewTitle" style="margin-top:0; color:#2c3e50;"></h2>
        <div id="viewBody" class="view-body"></div>
        <div id="viewLink" style="margin-top:20px;"></div>
        <button class="btn-save" onclick="closeViewModal()" style="background:#999; margin-top:20px;">ë‹« ê¸°</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('calendar')"><span class="nav-icon">ğŸ“…</span>í™ˆ</div>
    <div class="nav-item" onclick="switchTab('list')"><span class="nav-icon">ğŸ“‹</span>ëª©ë¡</div>
    <div class="nav-item" onclick="switchTab('write')"><span class="nav-icon">âœï¸</span>ê¸°ë¡</div>
    <div class="nav-item" onclick="switchTab('data')"><span class="nav-icon">ğŸ’¾</span>ë°ì´í„°</div>
</nav>

<script>
    // === ê¸°ë³¸ ì„¤ì • ===
    const DB_NAME = 'JeongArchiveDB_v9';
    const STORE_NAME = 'memos';
    let db;
    let currDate = new Date();

    // === ì•”í˜¸ ê´€ë ¨ ===
    function getPassword() { return localStorage.getItem('appPass') || "0403"; }
    function checkPass() {
        if(document.getElementById('passInput').value === getPassword()) {
            document.getElementById('loginOverlay').style.display = 'none';
        } else { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); document.getElementById('passInput').value=''; }
    }
    function changePassword() {
        const cur = prompt("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸:"); if(cur!==getPassword()) return alert("ì˜¤ë¥˜");
        const newP = prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸:"); if(newP) { localStorage.setItem('appPass', newP); alert("ë³€ê²½ ì™„ë£Œ"); }
    }

    // === DB ì´ˆê¸°í™” ===
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => { db = e.target.result; if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, {keyPath:'id'}); };
    request.onsuccess = e => { db = e.target.result; initApp(); };

    function initApp() { renderCalendar(); renderMemos(); }

    // === íƒ­ ì „í™˜ ===
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+tab).classList.add('active');
        
        const idx = ['calendar','list','write','data'].indexOf(tab);
        document.querySelectorAll('.nav-item')[idx].classList.add('active');

        if(tab === 'write') {
            if(!document.getElementById('editModeId').value) resetWriteForm();
        } else if (tab === 'list') {
            resetWriteForm();
            renderMemos();
        }
    }

    // === ë°ì´í„° ì €ì¥/ìˆ˜ì • ===
    async function saveMemo() {
        const title = document.getElementById('inputTitle').value;
        const rawText = document.getElementById('inputContent').value;
        const tag = document.getElementById('inputTag').value;
        const link = document.getElementById('inputLink').value;
        const editId = document.getElementById('editModeId').value;
        const oldImages = document.getElementById('hiddenOldImages').value; 

        if(!title && !rawText) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');

        let finalContent = rawText.replace(/\n/g, "<br>");
        if(oldImages) finalContent += oldImages;

        const files = document.getElementById('inputImage').files;
        if(files.length > 0) {
            finalContent += "<br>";
            for(let i=0; i<files.length; i++) {
                const imgData = await compressImage(files[i]);
                finalContent += `<img src="${imgData}" style="max-width:100%; border-radius:8px; margin-top:5px;"><br>`;
            }
        }

        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);

        if (editId) {
            store.get(Number(editId)).onsuccess = (e) => {
                const data = e.target.result;
                data.title = title; data.tag = tag; data.content = finalContent; data.link = link;
                store.put(data).onsuccess = () => {
                    alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    resetWriteForm();
                    switchTab('list');
                };
            };
        } else {
            const memo = {
                id: Date.now(),
                dateStr: new Date().toLocaleDateString('ko-KR'), 
                title: title || "ë¬´ì œ",
                tag: tag, content: finalContent, link: link
            };
            store.add(memo).onsuccess = () => {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                resetWriteForm();
                switchTab('calendar');
            };
        }
    }

    // === ìˆ˜ì • ëª¨ë“œ ì§„ì… ===
    function editMemoDirect(id) {
        db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).get(id).onsuccess = (e) => {
            const m = e.target.result;
            if(!m) return;
            
            document.getElementById('editModeId').value = m.id;
            document.getElementById('inputTitle').value = m.title;
            document.getElementById('inputTag').value = m.tag || '#ì¼ë°˜';
            
            const imgRegex = /<img[^>]*>/g;
            const images = m.content.match(imgRegex) || [];
            
            let onlyText = m.content.replace(imgRegex, "");
            onlyText = onlyText.replace(/<br\s*\/?>/gi, "\n");
            onlyText = onlyText.replace(/<div>/gi, "\n");
            onlyText = onlyText.replace(/<\/div>/gi, "");
            onlyText = onlyText.replace(/&nbsp;/gi, " ");
            onlyText = onlyText.replace(/<[^>]*>/g, "");
            onlyText = onlyText.trim();

            document.getElementById('inputContent').value = onlyText;
            
            const imgArea = document.getElementById('existingImagesArea');
            const imgPreview = document.getElementById('existingImagesPreview');
            const hiddenInput = document.getElementById('hiddenOldImages');
            
            if(images.length > 0) {
                imgArea.style.display = 'block';
                imgPreview.innerHTML = images.join(" ");
                hiddenInput.value = images.join("");     
            } else {
                imgArea.style.display = 'none';
                imgPreview.innerHTML = "";
                hiddenInput.value = "";
            }

            document.getElementById('inputLink').value = m.link;

            document.getElementById('writeModeTitle').innerText = "ğŸ“ ê¸°ë¡ ìˆ˜ì •í•˜ê¸°";
            document.getElementById('btnSaveAction').innerText = "ìˆ˜ì • ì™„ë£Œ";
            document.getElementById('btnSaveAction').style.background = "#f39c12"; 
            document.getElementById('btnCancelEdit').style.display = "block";

            switchTab('write');
        };
    }

    function deleteMemo(id) {
        if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(id).onsuccess = () => {
                renderMemos(); renderCalendar();
            };
        }
    }

    function resetWriteForm() {
        document.getElementById('editModeId').value = "";
        document.getElementById('inputTitle').value = "";
        document.getElementById('inputContent').value = "";
        document.getElementById('inputLink').value = "";
        document.getElementById('inputImage').value = "";
        document.getElementById('existingImagesArea').style.display = 'none';
        document.getElementById('hiddenOldImages').value = "";
        
        document.getElementById('writeModeTitle').innerText = "ğŸ“ ìƒˆ ê¸°ë¡ ì‘ì„±";
        document.getElementById('btnSaveAction').innerText = "ì € ì¥";
        document.getElementById('btnSaveAction').style.background = "#2c3e50";
        document.getElementById('btnCancelEdit').style.display = "none";
    }

    function cancelEdit() { resetWriteForm(); switchTab('list'); }

    // === ëª©ë¡ ë Œë”ë§ (ì´ˆê°•ë ¥ í•„í„° ì ìš©) ===
    async function renderMemos() {
        const list = document.getElementById('memoList'); list.innerHTML='';
        const memos = await getAll();
        
        const filter = document.getElementById('listFilter').value;
        const key = document.getElementById('searchInput').value;
        
        memos.sort((a,b) => b.id - a.id);
        
        memos.forEach(m => {
            // íƒœê·¸ ë§¤ì¹­ ë¡œì§ (ëª¨ë“  ê³µë°± ì œê±° í›„ ë¹„êµ)
            const rawTag = m.tag || '#ì¼ë°˜';
            const cleanTag = rawTag.replace(/\s+/g, ''); // DBì— ì €ì¥ëœ íƒœê·¸ ê³µë°±ì œê±°
            const cleanFilter = filter.replace(/\s+/g, ''); // í•„í„° ì„ íƒê°’ ê³µë°±ì œê±°

            if(cleanFilter !== 'all' && cleanTag !== cleanFilter) return;
            if(key && !m.title.includes(key) && !m.content.includes(key)) return;

            let summary = m.content.replace(/<[^>]*>?/gm, '');
            if(summary.length > 35) summary = summary.substring(0, 35) + "...";
            let hasImg = m.content.includes('<img') ? 'ğŸ“·' : '';
            
            let linkBtn = m.link ? `<a href="${m.link}" target="_blank" class="btn-mini btn-link" onclick="event.stopPropagation()">ğŸ”— ë§í¬</a>` : '';

            list.innerHTML += `
            <div class="memo-card">
                <div onclick="openViewModal(${m.id})">
                    <div style="display:flex; justify-content:space-between; color:#666; font-size:0.8rem;">
                        <span>${m.dateStr}</span>
                        <span style="color:var(--accent-color); font-weight:bold;">${rawTag}</span>
                    </div>
                    <h3 style="margin:8px 0; font-size:1.1rem; color:#2c3e50;">${m.title} ${hasImg}</h3>
                    <p style="color:#555; font-size:0.9rem; margin-bottom:5px;">${summary}</p>
                </div>
                <div class="list-action-bar">
                    ${linkBtn}
                    <button class="btn-mini btn-edit" onclick="editMemoDirect(${m.id})">ìˆ˜ì •</button>
                    <button class="btn-mini btn-del" onclick="deleteMemo(${m.id})">ì‚­ì œ</button>
                </div>
            </div>`;
        });
    }

    // === ê¸°íƒ€ ê¸°ëŠ¥ë“¤ ===
    async function openViewModal(id) {
        const memos = await getAll();
        const m = memos.find(x => x.id === id);
        if(!m) return;
        document.getElementById('viewTitle').innerText = m.title;
        document.getElementById('viewDate').innerText = m.dateStr;
        document.getElementById('viewTag').innerText = m.tag || '#ì¼ë°˜';
        document.getElementById('viewBody').innerHTML = m.content;
        document.getElementById('viewLink').innerHTML = m.link ? `<a href="${m.link}" target="_blank">ğŸ”— ë§í¬ ì—´ê¸°</a>` : '';
        document.getElementById('viewModal').style.display = 'flex';
    }
    function closeViewModal() { document.getElementById('viewModal').style.display = 'none'; }

    function getAll() { return new Promise(r => db.transaction(STORE_NAME,'readonly').objectStore(STORE_NAME).getAll().onsuccess = e => r(e.target.result)); }
    function compressImage(file) { return new Promise(r => { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { const c = document.createElement('canvas'); let w=img.width, h=img.height; if(w>1024) { h*=1024/w; w=1024; } c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); r(c.toDataURL('image/jpeg',0.7)); }; img.src = e.target.result; }; reader.readAsDataURL(file); }); }
    
    function changeMonth(d) { currDate.setMonth(currDate.getMonth()+d); renderCalendar(); }
    function normalizeDate(d) { return d.replace(/[.\-\s]/g, ''); }
    async function renderCalendar() {
        const y = currDate.getFullYear(), m = currDate.getMonth();
        document.getElementById('currentMonth').innerText = `${y}ë…„ ${m+1}ì›”`;
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        'ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† '.split('').forEach(d=>grid.innerHTML+=`<div style="text-align:center; font-size:0.8rem; color:#888;">${d}</div>`);
        const first = new Date(y,m,1).getDay(), last = new Date(y,m+1,0).getDate();
        for(let i=0; i<first; i++) grid.innerHTML+=`<div></div>`;
        const memos = await getAll();
        for(let d=1; d<=last; d++) {
            const targetStr = normalizeDate(`${y}${String(m+1).padStart(2,'0')}${String(d).padStart(2,'0')}`);
            const has = memos.some(x => normalizeDate(x.dateStr).includes(targetStr));
            const div = document.createElement('div'); div.className = 'cal-day' + (has ? ' has-memo' : '');
            const today = new Date(); if(y===today.getFullYear() && m===today.getMonth() && d===today.getDate()) div.classList.add('today');
            div.innerHTML = `<span>${d}</span>${has?'<div class="dot"></div>':''}`;
            div.onclick = () => showDayMemos(targetStr, memos);
            grid.appendChild(div);
        }
    }
    function showDayMemos(targetKey, memos) {
        const target = memos.filter(m => normalizeDate(m.dateStr).includes(targetKey));
        const box = document.getElementById('calendarMemos');
        box.innerHTML = target.length ? target.map(m=>`<div style="background:#fff; padding:10px; margin-bottom:5px; border:1px solid #eee;"><b>${m.title}</b></div>`).join('') : '<p>ê¸°ë¡ ì—†ìŒ</p>';
    }

    function backupData() { getAll().then(memos => { if(memos.length==0) return alert('ë°ì´í„° ì—†ìŒ'); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(memos)],{type:'application/json'})); a.download = `JDM_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }); }
    function resetApp() { if(confirm('ì „ì²´ ì´ˆê¸°í™”?')) { db.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).clear().onsuccess=()=>{ alert('ì´ˆê¸°í™” ì™„ë£Œ'); location.reload(); }; } }
    
    function restoreData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const data = JSON.parse(e.target.result);
            const tx = db.transaction(STORE_NAME, 'readwrite');
            (Array.isArray(data)?data:[data]).forEach(i => tx.objectStore(STORE_NAME).put(i));
            tx.oncomplete = () => { alert('ë³µì› ì™„ë£Œ'); location.reload(); };
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
