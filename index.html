<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JDM Archive v8.9</title>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #c0392b; --bg-color: #f4f6f7; --nav-height: 65px; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: #333; margin: 0; padding-bottom: var(--nav-height); }
        header { background: white; padding: 15px; text-align: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        
        /* ë‹¬ë ¥ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: white; padding: 10px; border-radius: 12px; }
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; border-radius: 8px; font-size: 0.9rem; cursor: pointer; }
        .cal-day.today { background: #e8f4fd; color: var(--primary-color); font-weight: bold; }
        .dot { width: 5px; height: 5px; background: var(--accent-color); border-radius: 50%; margin-top: 3px; }
        
        /* ëª©ë¡ */
        .memo-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-save { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; }
        
        /* ë°ì´í„° ê´€ë¦¬ */
        .restore-box { background: #e8f5e9; border: 2px solid #2e7d32; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 8px; color: #999; font-size: 0.8rem; }
        .nav-item.active { color: var(--primary-color); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; display: block; }
    </style>
</head>
<body>
<header><h1>JDM Archive v8.9</h1></header>

<div class="container">
    <div id="tab-calendar" class="tab-content active">
        <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:12px; margin-bottom:10px;">
            <button onclick="changeMonth(-1)" style="border:none; bg:none; font-size:1.2rem;">â—€</button>
            <h2 id="currentMonth" style="margin:0;"></h2>
            <button onclick="changeMonth(1)" style="border:none; bg:none; font-size:1.2rem;">â–¶</button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
        <div id="calendarMemos" style="margin-top:20px; text-align:center; color:#888;">ë‚ ì§œë¥¼ ëˆ„ë¥´ë©´ ê¸°ë¡ì´ ë‚˜ì˜µë‹ˆë‹¤.</div>
    </div>

    <div id="tab-list" class="tab-content">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" onkeyup="renderMemos()">
        <div id="memoList"></div>
    </div>

    <div id="tab-write" class="tab-content">
        <div style="background:white; padding:20px; border-radius:12px;">
            <h3>ğŸ“ ê¸°ë¡í•˜ê¸°</h3>
            <input type="text" id="title" placeholder="ì œëª©">
            <select id="tag"><option>#ì¼ë°˜</option><option>#ì—…ë¬´</option><option>#ì•„ì´ë””ì–´</option><option>#ìš”ë¦¬</option><option>#í˜„ì¥</option></select>
            <textarea id="content" style="height:100px" placeholder="ë‚´ìš©"></textarea>
            <input type="file" id="imageInput" accept="image/*">
            <button class="btn-save" onclick="saveMemo()">ì € ì¥</button>
        </div>
    </div>

    <div id="tab-data" class="tab-content">
        <div style="background:white; padding:20px; border-radius:12px;">
            <h3>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
            <button onclick="backupData()" class="btn-save" style="background:#27ae60; margin-bottom:20px;">ğŸ“¤ ë°±ì—… (íŒŒì¼ ì €ì¥)</button>
            
            <div class="restore-box">
                <strong style="color:#2e7d32; font-size:1.1rem;">ğŸ“¥ ë°ì´í„° ë³µì› (ê°•ì œ ì¶”ì¶œ)</strong>
                <p style="margin:5px 0;">ê°€ì§€ê³  ê³„ì‹  .json íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.<br>(ë¬´ì¡°ê±´ ë‚´ìš©ì„ ì°¾ì•„ëƒ…ë‹ˆë‹¤)</p>
                <input type="file" id="restoreInput" onchange="restoreData(this)">
            </div>
            <button onclick="resetApp()" class="btn-save" style="background:#7f8c8d;">âš ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('calendar')"><span class="nav-icon">ğŸ“…</span>í™ˆ</div>
    <div class="nav-item" onclick="switchTab('list')"><span class="nav-icon">ğŸ“‹</span>ëª©ë¡</div>
    <div class="nav-item" onclick="switchTab('write')"><span class="nav-icon">âœï¸</span>ê¸°ë¡</div>
    <div class="nav-item" onclick="switchTab('data')"><span class="nav-icon">ğŸ’¾</span>ë°ì´í„°</div>
</nav>

<script>
    const DB_NAME = 'JeongArchiveDB_v8';
    const STORE_NAME = 'memos';
    let db;

    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => { db = e.target.result; if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, {keyPath:'id'}); };
    request.onsuccess = e => { db = e.target.result; initApp(); };

    function initApp() { renderCalendar(); }
    
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+tab).classList.add('active');
        const idx = ['calendar','list','write','data'].indexOf(tab);
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        if(tab==='list') renderMemos();
    }

    async function saveMemo() {
        const title = document.getElementById('title').value;
        if(!title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
        let image = null;
        const file = document.getElementById('imageInput').files[0];
        if(file) image = await compressImage(file);
        const memo = {
            id: Date.now(),
            dateStr: new Date().toLocaleDateString('ko-KR'),
            fullDate: new Date().toLocaleString(),
            title, tag: document.getElementById('tag').value,
            content: document.getElementById('content').value,
            image
        };
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).add(memo);
        tx.oncomplete = () => { alert('ì €ì¥ë¨'); document.getElementById('title').value=''; switchTab('calendar'); renderCalendar(); };
    }

    // [í•µì‹¬] v8.9 ê°•ì œ ë°ì´í„° ì¶”ì¶œ ë¡œì§ (The Vacuum Cleaner)
    function restoreData(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                let raw = e.target.result;
                if (raw.charCodeAt(0) === 0xFEFF) raw = raw.slice(1);
                
                let data = JSON.parse(raw);
                if (typeof data === 'string') data = JSON.parse(data);

                if (!Array.isArray(data)) {
                     if(data.memos) data = data.memos;
                     else if(typeof data === 'object') data = Object.values(data);
                     else data = [data];
                }

                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                let count = 0;
                
                data.forEach(item => {
                    // [ë§ŒëŠ¥ ì—´ì‡  ë¡œì§]
                    let finalTitle = item.title || item.subject || item.name;
                    let finalContent = item.content || item.text || item.memo || item.body || item.desc;
                    let finalDate = item.dateStr || item.date || item.time || new Date().toLocaleDateString('ko-KR');

                    // ê·¸ë˜ë„ ë‚´ìš©ì´ ì—†ìœ¼ë©´? ë°ì´í„° ì•ˆì— ìˆëŠ” ëª¨ë“  ë¬¸ìì—´ì„ ë’¤ì ¸ì„œ í•©ì¹¨
                    if (!finalContent) {
                        let allStrings = [];
                        Object.values(item).forEach(val => {
                            if (typeof val === 'string' && val.length > 0 && !val.includes('data:image')) {
                                allStrings.push(val);
                            }
                        });
                        // ê°€ì¥ ê¸´ ê¸€ìë¥¼ ë‚´ìš©ìœ¼ë¡œ, ë‘ë²ˆì§¸ë¥¼ ì œëª©ìœ¼ë¡œ ì¶”ì •
                        allStrings.sort((a, b) => b.length - a.length);
                        if (allStrings.length > 0) finalContent = allStrings[0];
                        if (!finalTitle && allStrings.length > 1) finalTitle = allStrings[1];
                    }

                    // ìµœí›„ì˜ ìˆ˜ë‹¨: ê·¸ëƒ¥ ì›ë³¸ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤˜ë¼
                    if (!finalContent && !finalTitle) {
                        finalContent = JSON.stringify(item); 
                        finalTitle = "ë³µêµ¬ëœ ë°ì´í„°";
                    }
                    if (!finalTitle) finalTitle = finalContent.substring(0, 10) + "...";

                    const fixedItem = {
                        id: item.id || (Date.now() + count),
                        title: finalTitle,
                        content: finalContent,
                        dateStr: finalDate,
                        tag: item.tag || "#ë³µì›",
                        link: item.link || "",
                        image: item.image || item.img || null,
                    };

                    store.put(fixedItem);
                    count++;
                });

                tx.oncomplete = () => { 
                    alert(`âœ… ë³µì› ì™„ë£Œ! (${count}ê°œ)\nì´ì œ ë¬´ì¡°ê±´ ë³´ì¼ ê²ë‹ˆë‹¤.`); 
                    switchTab('list'); 
                };

            } catch (err) {
                alert(`ì˜¤ë¥˜: ${err.message}`);
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    function getAll() { return new Promise(r => db.transaction(STORE_NAME,'readonly').objectStore(STORE_NAME).getAll().onsuccess = e => r(e.target.result)); }
    
    async function renderMemos() {
        const list = document.getElementById('memoList'); list.innerHTML='';
        const memos = await getAll();
        const key = document.getElementById('searchInput').value;
        memos.reverse().forEach(m => {
            if(key && !m.title.includes(key)) return;
            
            list.innerHTML += `<div class="memo-card">
                <button onclick="del(${m.id})" style="float:right; border:none; bg:none; font-size:1.2rem;">Ã—</button>
                <small>${m.dateStr} ${m.tag}</small>
                <h3 style="margin:5px 0; color:#2c3e50;">${m.title}</h3>
                <p style="white-space:pre-wrap; color:#444;">${m.content}</p>
                ${m.image ? '<img src="'+m.image+'" style="width:100%; border-radius:8px; margin-top:10px;">' : ''}
            </div>`;
        });
    }

    function del(id) { if(confirm('ì‚­ì œ?')) db.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).delete(id).onsuccess = ()=>renderMemos(); }

    async function backupData() {
        const memos = await getAll();
        if(memos.length==0) return alert('ë°ì´í„° ì—†ìŒ');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(memos)],{type:'application/json'}));
        a.download = `JDM_Backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }
    
    let currDate = new Date();
    function changeMonth(d) { currDate.setMonth(currDate.getMonth()+d); renderCalendar(); }
    async function renderCalendar() {
        const y = currDate.getFullYear(), m = currDate.getMonth();
        document.getElementById('currentMonth').innerText = `${y}ë…„ ${m+1}ì›”`;
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        'ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† '.split('').forEach(d=>grid.innerHTML+=`<div style="text-align:center; font-size:0.8rem; color:#888;">${d}</div>`);
        const first = new Date(y,m,1).getDay(), last = new Date(y,m+1,0).getDate();
        for(let i=0; i<first; i++) grid.innerHTML+=`<div></div>`;
        const memos = await getAll();
        for(let d=1; d<=last; d++) {
            const dateStr = `${y}. ${m+1}. ${d}.`;
            const has = memos.some(x => x.dateStr === dateStr);
            const div = document.createElement('div');
            div.className = 'cal-day';
            div.innerHTML = `${d}${has?'<div class="dot"></div>':''}`;
            div.onclick = () => showDayMemos(dateStr, memos);
            grid.appendChild(div);
        }
    }
    function showDayMemos(dateStr, memos) {
        const target = memos.filter(m => m.dateStr === dateStr);
        const box = document.getElementById('calendarMemos');
        if(target.length==0) box.innerHTML = `<p>${dateStr} ê¸°ë¡ ì—†ìŒ</p>`;
        else box.innerHTML = target.map(m=>`<div style="background:#f9f9f9; padding:10px; margin:5px; border-radius:5px; text-align:left;"><b>${m.title}</b><br>${m.content}</div>`).join('');
    }

    function compressImage(file) {
        return new Promise(r => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    let w=img.width, h=img.height;
                    if(w>1024) { h*=1024/w; w=1024; }
                    c.width=w; c.height=h;
                    c.getContext('2d').drawImage(img,0,0,w,h);
                    r(c.toDataURL('image/jpeg',0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function resetApp() { if(confirm('ì „ì²´ ì‚­ì œ?')) db.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).clear().onsuccess=()=>{alert('ì™„ë£Œ'); renderCalendar();} }
</script>
</body>
</html>
