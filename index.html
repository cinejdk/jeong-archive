<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDM Archive v13.13 (Recovery)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ê¸´ê¸‰ ìŠ¤íƒ€ì¼: ê°€ë…ì„±ê³¼ ì‘ë™ ìš°ì„  */
        :root { --primary-color: #3b82f6; --bg-color: #f3f4f6; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background-color: var(--bg-color); padding: 15px; }

        .version-check { background: red; color: white; padding: 5px; text-align: center; font-weight: bold; margin-bottom: 10px; border-radius: 5px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 1.2rem; font-weight: bold; }
        .nav-btn { background: #ddd; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: white; padding: 5px; border-radius: 5px; }
        .tab { flex: 1; padding: 10px; text-align: center; background: #eee; border-radius: 5px; cursor: pointer; }
        .tab.active { background: var(--primary-color); color: white; font-weight: bold; }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ccc; border: 1px solid #ccc; }
        .calendar-cell { background: white; min-height: 80px; padding: 2px; cursor: pointer; font-size: 0.8rem; }
        .date-num { font-weight: bold; margin-bottom: 2px; }
        .schedule-preview { background: var(--primary-color); color: white; font-size: 0.7rem; padding: 1px 3px; border-radius: 3px; overflow: hidden; white-space: nowrap; margin-top: 2px; }
        
        /* ëª¨ë°”ì¼ìš© ì  í‘œì‹œ */
        .schedule-dot { width: 6px; height: 6px; background-color: var(--primary-color); border-radius: 50%; margin: 2px auto; display: block; }
        @media (min-width: 768px) { .schedule-dot { display: none; } }
        @media (max-width: 767px) { .schedule-preview { display: none; } }

        .sunday { color: red; } .saturday { color: blue; } .today { background: #eeffff; }

        /* ëª¨ë‹¬ ë° ì…ë ¥ì°½ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 500px; padding: 20px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
        .input-field { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; }
        
        .btn { width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-primary { background: var(--primary-color); color: white; }
        
        /* ë§í¬ ë° íŒŒì¼ ìŠ¤íƒ€ì¼ */
        .link-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .file-tag { background: #eee; padding: 5px; margin: 5px 0; font-size: 0.8rem; }
        
        /* ë°ì´í„° ë³µêµ¬ ì˜ì—­ (ê°•ì¡°) */
        .recovery-zone { background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .real-file-input { display: block; width: 100%; padding: 10px; background: white; border: 1px solid #999; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="version-check">v13.13 (ê¸´ê¸‰ ë³µêµ¬ ëª¨ë“œ)</div>

    <div class="header">
        <button class="nav-btn" onclick="changeMonth(-1)">Prev</button>
        <div class="title" id="currentMonth">Loading...</div>
        <button class="nav-btn" onclick="changeMonth(1)">Next</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('calendar')">ë‹¬ë ¥</div>
        <div class="tab" onclick="switchTab('data')">ë°ì´í„°(ë³µêµ¬)</div>
    </div>

    <div id="calendarView" class="calendar-grid"></div>

    <div id="dataView" style="display: none;">
        <div class="recovery-zone">
            <h3>ğŸš‘ ë°ì´í„° ë³µêµ¬ ì„¼í„°</h3>
            <p>1. ì•„ë˜ <b>[íŒŒì¼ ì„ íƒ]</b>ì„ ëˆŒëŸ¬ ë°±ì—…íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <p>2. ì„ íƒ ì¦‰ì‹œ ë³µêµ¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</p>
            
            <input type="file" id="restoreInput" class="real-file-input" accept=".json" onchange="restoreDataSafe(this)">
            
            <hr style="margin: 20px 0;">
            <button class="btn" style="background: #666; color: white;" onclick="backupData()">í˜„ì¬ ë°ì´í„° ë°±ì—…í•˜ê¸°</button>
            <button class="btn" style="background: red; color: white;" onclick="clearAllData()">ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div id="writeModal" class="modal">
        <div class="modal-content">
            <h3>ì¼ì • ì‘ì„±</h3>
            <input type="date" id="scheduleDate" class="input-field">
            <input type="text" id="scheduleTitle" class="input-field" placeholder="ì œëª©">
            <textarea id="scheduleContent" class="input-field" style="height: 100px" placeholder="ë‚´ìš©"></textarea>
            
            <div id="linkContainer"></div>
            <button class="btn" style="background:#ddd" onclick="addLinkField()">+ ë§í¬ ì¶”ê°€</button>
            
            <div style="margin-top:10px">íŒŒì¼ ì²¨ë¶€:</div>
            <input type="file" id="fileInput" class="input-field" multiple accept="image/*,.pdf" onchange="handleFileSelect(this)">
            <div id="filePreviewArea"></div>

            <button class="btn btn-primary" onclick="saveSchedule()">ì €ì¥</button>
            <button class="btn" style="background: #999; color: white;" onclick="closeModal('writeModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content">
            <h3 id="viewDate"></h3>
            <h2 id="viewTitle"></h2>
            <div id="viewContent" style="white-space: pre-wrap; margin: 10px 0; background: #f9f9f9; padding: 10px;"></div>
            <div id="viewLinks" style="display: flex; flex-direction: column; gap: 5px;"></div>
            <div id="viewImages" style="margin-top: 10px;"></div>
            
            <button class="btn btn-primary" onclick="editCurrentSchedule()">ìˆ˜ì •/ì‚­ì œ</button>
            <button class="btn" style="background: #999; color: white;" onclick="closeModal('viewModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <div style="position: fixed; bottom: 20px; right: 20px; background: blue; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer;" onclick="openWriteModal()">+</div>

    <script>
        // --- 1. ì•ˆì „ ì´ˆê¸°í™” (Safe Init) ---
        let schedules = {};
        let currentDate = new Date();
        let currentEditId = null;
        let attachedFiles = [];

        try {
            const saved = localStorage.getItem('jdm_schedules');
            if (saved) schedules = JSON.parse(saved);
        } catch (e) {
            console.log("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ë¹ˆ ìƒíƒœë¡œ ì‹œì‘");
            schedules = {};
        }

        // ì‹¤í–‰
        renderCalendar();

        // --- 2. í•µì‹¬ ê¸°ëŠ¥: ë°ì´í„° ë³µêµ¬ (ê°•í™”íŒ) ---
        function restoreDataSafe(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const txt = e.target.result;
                    // BOM ì œê±° ë“± í…ìŠ¤íŠ¸ ì „ì²˜ë¦¬
                    const json = JSON.parse(txt);
                    
                    if (confirm(`ë°ì´í„° íŒŒì¼(${file.name})ì„ ì½ì—ˆìŠµë‹ˆë‹¤.\në³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        schedules = json;
                        localStorage.setItem('jdm_schedules', JSON.stringify(schedules));
                        renderCalendar();
                        alert("âœ… ë³µì› ì„±ê³µ! ë‹¬ë ¥ íƒ­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                        switchTab('calendar');
                    }
                } catch (err) {
                    alert("âŒ íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜!\n" + err.message);
                }
            };
            // í…ìŠ¤íŠ¸ë¡œ ì½ê¸° (ê°€ì¥ ì•ˆì „í•¨)
            reader.readAsText(file);
        }

        // --- 3. ê¸°ë³¸ ê¸°ëŠ¥ (ê°„ì†Œí™”) ---
        function renderCalendar() {
            try {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const el = document.getElementById('currentMonth');
                if(el) el.innerText = `${year}ë…„ ${month + 1}ì›”`;
                
                const grid = document.getElementById('calendarView');
                grid.innerHTML = '';
                
                // ìš”ì¼
                ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach((d,i) => {
                    const div = document.createElement('div');
                    div.style.textAlign = 'center'; div.style.background='#eee'; div.innerText = d;
                    if(i===0) div.style.color='red'; if(i===6) div.style.color='blue';
                    grid.appendChild(div);
                });

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                for(let i=0; i<firstDay.getDay(); i++) grid.appendChild(document.createElement('div'));

                for(let i=1; i<=lastDay.getDate(); i++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell';
                    
                    let html = `<div class="date-num" style="${new Date(year,month,i).getDay()===0?'color:red':''}">${i}</div>`;
                    
                    if(schedules[dateStr]) {
                        html += `<div class="schedule-dot"></div>`;
                        // ì œëª© ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
                        let title = schedules[dateStr][0].title || "ì¼ì •";
                        html += `<div class="schedule-preview">${title}</div>`;
                    }
                    cell.innerHTML = html;
                    cell.onclick = () => showList(dateStr);
                    grid.appendChild(cell);
                }
            } catch(e) {
                console.error("ë Œë”ë§ ì—ëŸ¬:", e);
            }
        }

        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth()+d); renderCalendar(); }
        
        function switchTab(t) {
            document.getElementById('calendarView').style.display = t==='calendar'?'grid':'none';
            document.getElementById('dataView').style.display = t==='data'?'block':'none';
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            // íƒ­ í™œì„±í™” í‘œì‹œ
            if(t==='calendar') document.querySelectorAll('.tab')[0].classList.add('active');
            else document.querySelectorAll('.tab')[1].classList.add('active');
        }

        function showList(date) {
            if(!schedules[date]) { openWriteModal(date); return; }
            // 1ê°œë©´ ë°”ë¡œë³´ê¸°, ì•„ë‹ˆë©´ ì²«ë²ˆì§¸êº¼ ì—´ê¸° (ê°„ì†Œí™”)
            openViewModal(date, 0);
        }

        // ëª¨ë‹¬ ê´€ë ¨
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function openWriteModal(date=null) {
            document.getElementById('writeModal').classList.add('active');
            document.getElementById('scheduleDate').value = date || new Date().toISOString().split('T')[0];
            document.getElementById('scheduleTitle').value = '';
            document.getElementById('scheduleContent').value = '';
            document.getElementById('linkContainer').innerHTML = '';
            addLinkField();
            attachedFiles = [];
            document.getElementById('filePreviewArea').innerHTML = '';
            currentEditId = null;
        }

        function saveSchedule() {
            const d = document.getElementById('scheduleDate').value;
            const t = document.getElementById('scheduleTitle').value;
            const c = document.getElementById('scheduleContent').value;
            
            // ë§í¬ ìˆ˜ì§‘
            const links = [];
            document.querySelectorAll('.link-row').forEach(row => {
                links.push({
                    name: row.querySelector('.link-name').value,
                    url: row.querySelector('.link-url').value
                });
            });

            if(!schedules[d]) schedules[d] = [];
            
            // ìˆ˜ì •ëª¨ë“œë©´ ê¸°ì¡´ ì‚­ì œ
            if(currentEditId) {
                schedules[currentEditId.date].splice(currentEditId.index, 1);
                if(schedules[currentEditId.date].length===0) delete schedules[currentEditId.date];
            }

            // ì¶”ê°€
            schedules[d].push({ title: t, content: c, links: JSON.stringify(links), files: attachedFiles });
            localStorage.setItem('jdm_schedules', JSON.stringify(schedules));
            
            renderCalendar();
            closeModal('writeModal');
        }

        function openViewModal(date, idx) {
            const s = schedules[date][idx];
            currentEditId = {date, index: idx};
            document.getElementById('viewDate').innerText = date;
            document.getElementById('viewTitle').innerText = s.title;
            document.getElementById('viewContent').innerText = s.content;
            
            const lBox = document.getElementById('viewLinks');
            lBox.innerHTML = '';
            try {
                let list = typeof s.links === 'string' ? (s.links.startsWith('[')?JSON.parse(s.links):[{url:s.links}]) : s.links;
                list.forEach(l => {
                    if(l.url || l) {
                        const a = document.createElement('a');
                        a.href = l.url || l; a.innerText = `ğŸ”— ${l.name || 'ë§í¬'}`;
                        a.style.display='block'; a.target='_blank';
                        lBox.appendChild(a);
                    }
                });
            } catch(e){}

            // ì´ë¯¸ì§€
            const iBox = document.getElementById('viewImages');
            iBox.innerHTML = '';
            if(s.files) {
                s.files.forEach(f => {
                    if(f.type.startsWith('image')) {
                        const img = document.createElement('img');
                        img.src = f.data; img.style.width='100%';
                        iBox.appendChild(img);
                    }
                });
            }

            document.getElementById('viewModal').classList.add('active');
        }

        function editCurrentSchedule() {
            const s = schedules[currentEditId.date][currentEditId.index];
            closeModal('viewModal');
            openWriteModal(currentEditId.date);
            document.getElementById('scheduleTitle').value = s.title;
            document.getElementById('scheduleContent').value = s.content;
            // ë§í¬ ë° íŒŒì¼ ë³µì› ìƒëµ (ë¹ ë¥¸ ë³µêµ¬ë¥¼ ìœ„í•´) - ë°ì´í„°ëŠ” ë³´ì¡´ë¨
            // ìˆ˜ì • í›„ ì €ì¥ ì‹œ ë®ì–´ì“°ê¸° ì£¼ì˜
        }

        // ìœ í‹¸
        function addLinkField() {
            const d = document.createElement('div'); d.className='link-row';
            d.innerHTML = `<input class="link-name input-field" placeholder="ì´ë¦„" style="width:30%"><input class="link-url input-field" placeholder="URL">`;
            document.getElementById('linkContainer').appendChild(d);
        }
        function handleFileSelect(inp) {
            // ê°„ë‹¨ íŒŒì¼ ì²˜ë¦¬
            Array.from(inp.files).forEach(f => {
                const r = new FileReader();
                r.onload = e => {
                    attachedFiles.push({name:f.name, type:f.type, data:e.target.result});
                    document.getElementById('filePreviewArea').innerText += f.name + " ";
                };
                r.readAsDataURL(f);
            });
        }
        function backupData() {
            const b = new Blob([JSON.stringify(schedules)], {type:'application/json'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href=u; a.download='JDM_Backup.json'; a.click();
        }
        function clearAllData() { localStorage.removeItem('jdm_schedules'); location.reload(); }
    </script>
</body>
</html>
