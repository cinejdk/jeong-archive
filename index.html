<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDM Archive v13.14 (Universal Fix)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #3b82f6; --bg-color: #f3f4f6; --text-color: #1f2937; --card-bg: #ffffff; --border-color: #e5e7eb; --sunday-color: #ef4444; --saturday-color: #3b82f6; }
        @media (prefers-color-scheme: dark) { :root { --bg-color: #111827; --text-color: #f9fafb; --card-bg: #1f2937; --border-color: #374151; } }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); padding: 15px; }

        /* 복구 센터 스타일 (강조) */
        .recovery-box { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin-bottom: 20px; color: #333; }
        .recovery-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        
        .method-box { background: white; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #ddd; }
        .method-label { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: #3b82f6; }
        
        .backup-textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; font-size: 0.8rem; margin-bottom: 5px; }

        /* 기존 스타일 유지 */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 1.3rem; font-weight: bold; }
        .nav-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-color); padding: 5px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: var(--card-bg); padding: 5px; border-radius: 10px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 0.9rem; }
        .tab.active { background-color: var(--primary-color); color: white; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-color); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
        .calendar-header { background: var(--card-bg); padding: 8px 0; text-align: center; font-weight: bold; font-size: 0.8rem; }
        .calendar-cell { background: var(--card-bg); min-height: 80px; padding: 4px; cursor: pointer; display: flex; flex-direction: column; gap: 2px; }
        .date-num { font-size: 0.85rem; font-weight: bold; }
        
        .schedule-preview { font-size: 0.7rem; color: white; background: var(--primary-color); padding: 2px 4px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: none; }
        .schedule-dot { width: 5px; height: 5px; background: var(--primary-color); border-radius: 50%; margin: 2px auto; }
        @media (min-width: 768px) { .schedule-preview { display: block; } .schedule-dot { display: none; } }

        .sunday { color: var(--sunday-color); } .saturday { color: var(--saturday-color); } .today { background: rgba(59, 130, 246, 0.1); }

        .list-view { display: none; flex-direction: column; gap: 10px; }
        .list-item { background: var(--card-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); width: 92%; max-width: 500px; border-radius: 15px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        
        .input-group { margin-bottom: 15px; }
        .input-field { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); }
        
        .link-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--primary-color); color: white; }
        
        .fab { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 900; cursor: pointer;}
    </style>
</head>
<body>

    <div class="header">
        <button class="nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="title" id="currentMonth"></div>
        <button class="nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('calendar')">달력</div>
        <div class="tab" onclick="switchTab('list')">목록</div>
        <div class="tab" onclick="switchTab('data')">데이터</div>
    </div>

    <div id="calendarView" class="calendar-grid"></div>
    <div id="listView" class="list-view"></div>

    <div id="dataView" class="list-view" style="display: none;">
        
        <div class="recovery-box">
            <div class="recovery-title"><i class="fas fa-file-upload"></i> 방법 1. 파일로 복원</div>
            <div class="method-box">
                <p style="font-size:0.8rem; margin-bottom:5px;">크롬/삼성인터넷 추천 (네이버앱은 안될 수 있음)</p>
                <input type="file" id="restoreFile" style="width:100%" accept=".json" onchange="restoreDataFile(this)">
            </div>
        </div>

        <div class="recovery-box" style="border-color: #3b82f6; background: #eff6ff;">
            <div class="recovery-title"><i class="fas fa-paste"></i> 방법 2. 붙여넣기로 복원</div>
            <div class="method-box">
                <p style="font-size:0.8rem; margin-bottom:5px;">파일이 안 열리면, 백업 파일 내용을 복사해서 아래에 붙여넣으세요.</p>
                <textarea id="jsonPasteInput" class="backup-textarea" placeholder=' 여기에 내용을 붙여넣고 [복원하기] 버튼을 누르세요. example: {"2025-10-23": [...]}'></textarea>
                <button class="btn btn-primary" onclick="restoreDataText()">텍스트로 복원하기</button>
            </div>
        </div>

        <div class="data-manage-box" style="margin-top: 20px;">
            <button class="btn" style="background:#666; color:white" onclick="backupData()">현재 데이터 백업 (파일저장)</button>
            <button class="btn" style="background:#ef4444; color:white; margin-top:10px;" onclick="clearAllData()">전체 초기화</button>
        </div>
    </div>

    <div id="writeModal" class="modal">
        <div class="modal-content">
            <h3>일정 기록</h3>
            <div class="input-group"><input type="date" id="scheduleDate" class="input-field"></div>
            <div class="input-group"><input type="text" id="scheduleTitle" class="input-field" placeholder="제목"></div>
            <div class="input-group"><textarea id="scheduleContent" class="input-field" style="height:100px" placeholder="내용"></textarea></div>
            <div class="input-group">
                <div id="linkContainer"></div>
                <button type="button" class="btn" style="padding:8px; background:#ccc" onclick="addLinkField()">+ 링크 추가</button>
            </div>
            <div class="input-group">
                <input type="file" id="fileInput" class="input-field" multiple onchange="handleFileSelect(this)">
                <div id="filePreviewArea"></div>
            </div>
            <button class="btn btn-primary" onclick="saveSchedule()">저장</button>
            <button class="btn" style="background:#999; color:white" onclick="closeModal('writeModal')">닫기</button>
        </div>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content">
            <h3 id="viewDate"></h3>
            <h2 id="viewTitle" style="margin:10px 0"></h2>
            <div id="viewContent" style="white-space: pre-wrap; background:#f9f9f9; padding:10px; border-radius:5px;"></div>
            <div id="viewLinks" style="margin-top:10px; display:flex; flex-direction:column; gap:5px;"></div>
            <div id="viewImages" style="margin-top:10px;"></div>
            <button class="btn btn-primary" onclick="editCurrentSchedule()">수정</button>
            <button class="btn" style="background:#999; color:white" onclick="closeModal('viewModal')">닫기</button>
        </div>
    </div>

    <div class="fab" onclick="openWriteModal()">+</div>

    <script>
        let schedules = {};
        let currentDate = new Date();
        let currentEditId = null;
        let attachedFiles = [];

        // 안전 로딩
        try {
            const saved = localStorage.getItem('jdm_schedules');
            if (saved) schedules = JSON.parse(saved);
        } catch (e) { schedules = {}; }

        renderCalendar();

        // --- 핵심 복구 로직 1: 파일 (BOM 제거 기능 추가) ---
        function restoreDataFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let txt = e.target.result;
                    // BOM(Byte Order Mark) 제거: 윈도우 메모장이 남긴 투명한 점 제거
                    if (txt.charCodeAt(0) === 0xFEFF) {
                        txt = txt.slice(1);
                    }
                    const data = JSON.parse(txt);
                    applyRestore(data);
                } catch (err) {
                    alert('파일 형식이 올바르지 않습니다.\n' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // --- 핵심 복구 로직 2: 텍스트 붙여넣기 ---
        function restoreDataText() {
            const txt = document.getElementById('jsonPasteInput').value.trim();
            if (!txt) { alert('내용을 붙여넣어 주세요.'); return; }
            try {
                // 혹시 모르니 여기서도 BOM 제거 시도
                let cleanTxt = txt;
                if (cleanTxt.charCodeAt(0) === 0xFEFF) cleanTxt = cleanTxt.slice(1);
                
                const data = JSON.parse(cleanTxt);
                applyRestore(data);
            } catch (err) {
                alert('텍스트 형식이 올바르지 않습니다. 정확히 복사했는지 확인해주세요.\n' + err.message);
            }
        }

        function applyRestore(data) {
            if (confirm('데이터를 복원하시겠습니까? (기존 데이터는 덮어씌워집니다)')) {
                schedules = data;
                localStorage.setItem('jdm_schedules', JSON.stringify(schedules));
                renderCalendar();
                alert('✅ 복원 완료! 달력 탭으로 이동합니다.');
                switchTab('calendar');
            }
        }

        // --- 기본 기능 ---
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('currentMonth').innerText = `${year}년 ${month + 1}월`;
            const grid = document.getElementById('calendarView');
            grid.innerHTML = '';
            
            ['일','월','화','수','목','금','토'].forEach((d,i) => {
                const div = document.createElement('div');
                div.className = 'calendar-header' + (i===0?' sunday':(i===6?' saturday':''));
                div.innerText = d;
                grid.appendChild(div);
            });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            for(let i=0; i<firstDay.getDay(); i++) grid.appendChild(document.createElement('div'));

            for(let i=1; i<=lastDay.getDate(); i++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                if(dateStr === new Date().toISOString().split('T')[0]) cell.classList.add('today');
                
                let html = `<div class="date-num ${new Date(year,month,i).getDay()===0?'sunday':''}">${i}</div>`;
                if(schedules[dateStr]) {
                    html += `<div class="schedule-dot"></div>`;
                    let title = schedules[dateStr][0].title || '일정';
                    html += `<div class="schedule-preview">${title}</div>`;
                }
                cell.innerHTML = html;
                cell.onclick = () => showList(dateStr);
                grid.appendChild(cell);
            }
            renderList();
        }

        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth()+d); renderCalendar(); }
        function switchTab(t) {
            document.querySelectorAll('.tab').forEach((el, idx) => {
                el.classList.remove('active');
                if((t==='calendar' && idx===0) || (t==='list' && idx===1) || (t==='data' && idx===2)) el.classList.add('active');
            });
            document.getElementById('calendarView').style.display = t==='calendar'?'grid':'none';
            document.getElementById('listView').style.display = t==='list'?'flex':'none';
            document.getElementById('dataView').style.display = t==='data'?'block':'none';
        }
        function renderList() {
            const l = document.getElementById('listView'); l.innerHTML='';
            Object.keys(schedules).sort().reverse().forEach(d => {
                schedules[d].forEach((s,i) => {
                    const div = document.createElement('div'); div.className='list-item';
                    div.innerHTML=`<div style="color:#888;font-size:0.8rem">${d}</div><div>${s.title}</div>`;
                    div.onclick=()=>openViewModal(d,i);
                    l.appendChild(div);
                });
            });
        }
        function showList(d) { if(!schedules[d]) openWriteModal(d); else openViewModal(d, 0); }

        function openWriteModal(d=null) {
            document.getElementById('writeModal').classList.add('active');
            document.getElementById('scheduleDate').value = d || new Date().toISOString().split('T')[0];
            document.getElementById('scheduleTitle').value = '';
            document.getElementById('scheduleContent').value = '';
            document.getElementById('linkContainer').innerHTML = ''; addLinkField();
            attachedFiles = []; document.getElementById('filePreviewArea').innerHTML='';
            currentEditId = null;
        }
        function saveSchedule() {
            const d = document.getElementById('scheduleDate').value;
            const t = document.getElementById('scheduleTitle').value;
            const c = document.getElementById('scheduleContent').value;
            const links = [];
            document.querySelectorAll('.link-row').forEach(r => {
                links.push({ name: r.querySelector('.link-name').value, url: r.querySelector('.link-url').value });
            });
            if(!schedules[d]) schedules[d] = [];
            if(currentEditId) { schedules[currentEditId.date].splice(currentEditId.index,1); if(schedules[currentEditId.date].length===0) delete schedules[currentEditId.date]; }
            schedules[d].push({ title:t, content:c, links:JSON.stringify(links), files:attachedFiles });
            localStorage.setItem('jdm_schedules', JSON.stringify(schedules));
            renderCalendar(); closeModal('writeModal');
        }
        function openViewModal(d, i) {
            const s = schedules[d][i]; currentEditId = {date:d, index:i};
            document.getElementById('viewDate').innerText=d; document.getElementById('viewTitle').innerText=s.title;
            document.getElementById('viewContent').innerText=s.content;
            const lBox=document.getElementById('viewLinks'); lBox.innerHTML='';
            try {
                let list = typeof s.links==='string'?(s.links.startsWith('[')?JSON.parse(s.links):[{url:s.links}]):s.links;
                list.forEach(l=>{ if(l.url||l) { 
                    const a=document.createElement('a'); a.href=l.url||l; a.target='_blank'; a.className='btn'; a.style='padding:5px; background:#eff6ff; color:blue; text-align:left; border:1px solid #bfdbfe';
                    a.innerHTML=`<i class="fas fa-link"></i> ${l.name||'링크'}`; lBox.appendChild(a);
                }});
            } catch(e){}
            const iBox=document.getElementById('viewImages'); iBox.innerHTML='';
            if(s.files) s.files.forEach(f=>{ if(f.type.startsWith('image')) { const img=document.createElement('img'); img.src=f.data; img.style='width:100%; border-radius:5px; margin-top:5px'; iBox.appendChild(img); }});
            document.getElementById('viewModal').classList.add('active');
        }
        function editCurrentSchedule() {
            const s = schedules[currentEditId.date][currentEditId.index];
            closeModal('viewModal'); openWriteModal(currentEditId.date);
            document.getElementById('scheduleTitle').value=s.title; document.getElementById('scheduleContent').value=s.content;
            document.getElementById('linkContainer').innerHTML='';
            try { JSON.parse(s.links).forEach(l=>addLinkField(l.name, l.url)); } catch(e){ addLinkField(); }
            attachedFiles=s.files||[]; 
            attachedFiles.forEach(f=>document.getElementById('filePreviewArea').innerHTML+=`<span style="font-size:0.8rem; background:#eee; padding:2px 5px; margin-right:5px">${f.name}</span>`);
        }
        function addLinkField(n='', u='') {
            const d=document.createElement('div'); d.className='link-row';
            d.innerHTML=`<input class="link-name input-field" value="${n}" placeholder="이름" style="width:30%"><input class="link-url input-field" value="${u}" placeholder="URL">`;
            document.getElementById('linkContainer').appendChild(d);
        }
        function handleFileSelect(inp) {
            Array.from(inp.files).forEach(f=>{ const r=new FileReader(); r.onload=e=>{ attachedFiles.push({name:f.name, type:f.type, data:e.target.result}); document.getElementById('filePreviewArea').innerHTML+=f.name+" "; }; r.readAsDataURL(f); });
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function backupData() {
            const b = new Blob([JSON.stringify(schedules)], {type:'application/json'});
            const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=`JDM_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }
        function clearAllData() { if(confirm('전체 삭제??')) { localStorage.removeItem('jdm_schedules'); location.reload(); } }
    </script>
</body>
</html>
